# Touch Down Card Game - 게임 로직 문서

## 1. 게임 개요

Touch Down Card Game은 할리갈리(Halli Galli) 게임의 온라인 멀티플레이어 버전입니다.

### 1.1 기본 규칙
게임은 카드를 모으는 식으로 진행되며, 카드를 모두 잃으면 탈락하고 마지막까지 카드가 남아있는 사람이 승리하게 됩니다.

- 시작하기 전에, 56장의 카드를 나누어 각자의 앞에 놓고 종을 중앙에 놓습니다.
- 카드는 본인도 뭘 가지고 있는지 모르게 뒤집어 놓습니다.
- 정해진 방향으로 돌아가면서, 각자 카드를 한 장씩 뒤집어서 놓으며 공개합니다.
- 바닥에 놓인 펼쳐진 카드들 중에서 **같은 과일의 개수가 정확히 5개**가 될 때 앞에 놓은 종을 최대한 빨리 칩니다.
- 종을 가장 빨리 친 사람이 바닥에 놓인 모든 카드(중앙 카드 + 버림 카드)를 가져갑니다.

## 2. 카드 구성

### 2.1 카드 종류
- **과일**: 딸기(🍓), 바나나(🍌), 자두(🍇), 레몬(🍋) - 4종류
- **개수**: 각 카드에 1~5개의 과일이 그려져 있음

### 2.2 카드 분배
- 1개짜리: 5장
- 2개짜리: 3장
- 3개짜리: 3장
- 4개짜리: 2장
- 5개짜리: 1장

**총 14장 × 4종류 = 56장**

## 3. 게임 진행

### 3.1 게임 시작
1. 방장이 방을 생성하고 최대 인원수 설정
2. 플레이어들이 방에 입장
3. 모든 플레이어가 "준비" 버튼 클릭
4. **3초 카운트다운** 후 게임 시작
5. 카드를 섞어서 플레이어들에게 균등하게 분배

### 3.2 턴 진행
1. 현재 턴 플레이어가 자신의 덱에서 **맨 위 카드 한 장**을 뒤집어서 중앙에 놓음
2. 카드는 플레이어별로 개별 스택에 쌓임
3. 다음 플레이어에게 턴이 넘어감
4. **각 플레이어의 맨 위 카드만** 게임에 영향을 줌

### 3.3 할리갈리 (벨 치기)
#### 성공 조건
- **각 플레이어의 맨 위 카드**를 보고 **같은 과일의 합이 정확히 5개**일 때
- 예시:
  - Player A 맨 위: 바나나 3개
  - Player B 맨 위: 바나나 2개
  - → 바나나 5개 = 할리갈리 성공! ✅

#### 성공 시
1. 중앙에 쌓인 모든 카드 획득
2. 버림 카드 더미의 모든 카드 획득
3. 획득한 카드를 **섞어서** 자신의 덱 **맨 아래**에 추가
4. 점수 증가 (획득한 카드 수만큼)
5. 모든 플레이어의 중앙 카드 스택 초기화

#### 실패 시
1. 자신의 덱에서 **맨 아래 카드 1장**(보이지 않는 카드) 제거
2. 제거한 카드를 **버림 카드 더미**에 추가
3. 버림 카드 더미는 할리갈리 조건 체크에 영향을 주지 않음

### 3.4 게임 종료
1. 한 명을 제외한 모든 플레이어의 카드가 0이 되면 게임 종료
2. **가장 많은 카드를 보유한 플레이어**가 승리
3. 최종 결과 화면에 카드 개수와 점수 표시

## 4. 구현된 주요 기능

### 4.1 게임 상태 관리
```javascript
gameState: {
  phase: 'playing',              // 게임 단계
  currentTurn: 0,                // 현재 턴 인덱스
  centerCards: [],               // 전체 중앙 카드 (히스토리)
  playerStacks: {},              // 플레이어별 카드 스택
  discardedCards: [],            // 버림 카드 더미
  remainingDeck: 0,              // 남은 덱 카드 수
  gameStartTime: '...',          // 게임 시작 시간
  lastActionTime: '...'          // 마지막 액션 시간
}
```

### 4.2 할리갈리 체크 로직
```javascript
// 각 플레이어의 맨 위 카드만 추출
const topCards = Object.values(playerStacks)
  .filter(stack => stack.length > 0)
  .map(stack => stack[stack.length - 1]);

// 과일별 합계 계산
const cardSums = calculateCardSum(topCards);

// 어떤 과일이든 정확히 5개면 할리갈리
const isHalliGalli = Object.values(cardSums).some(sum => sum === 5);
```

### 4.3 카드 획득 로직
```javascript
// 할리갈리 성공 시
const gainedCards = [...centerCards, ...discardedCards];
const shuffledCards = shuffleCards(gainedCards);
player.cardPack.push(...shuffledCards);  // 덱 맨 아래에 추가
```

## 5. UI/UX 기능

### 5.1 게임 보드
- **중앙 플레이어 카드 스택**: 각 플레이어별로 카드 더미 표시
- **현재 턴 표시**: 현재 턴 플레이어의 카드 스택에 초록색 테두리 + 펄스 효과
- **카드 개수 표시**: 각 플레이어의 남은 카드 개수 실시간 업데이트
- **버림 카드 더미**: 우측에 별도로 표시 (보라색 테두리)

### 5.2 할리갈리 벨
- **중앙 배치**: 게임 보드 중앙에 큰 황금색 벨
- **애니메이션**:
  - 호버: 확대 효과
  - 클릭: 눌림 + 흔들림 효과
  - 성공: 초록색 펄스 + 회전
  - 실패: 빨간색 흔들림
- **사운드**: Web Audio API를 사용한 벨 소리

### 5.3 알림 시스템
- **할리갈리 성공**: 🎉 애니메이션 + "+X점 획득! (중앙 Y장 + 버림 Z장)"
- **할리갈리 실패**: ❌ 애니메이션 + "카드 1장 버림"
- **게임 시작 카운트다운**: 3, 2, 1 카운트 표시

### 5.4 게임 종료 화면
- **승리/패배 모달**: 애니메이션과 함께 결과 표시
- **최종 순위**: 카드 개수 순으로 정렬
- **컨페티 효과**: 승리 시 화면에 컨페티 애니메이션

## 6. 기술적 구현

### 6.1 서버 사이드
- **Socket.IO 이벤트 기반**: 실시간 게임 상태 동기화
- **게임 타이머**: 게임 시작 전 3초 카운트다운 (취소 및 재검증 포함)
- **턴 관리**: 순환 방식의 턴 진행
- **상태 검증**: 각 액션마다 유효성 검사

### 6.2 클라이언트 사이드
- **실시간 UI 업데이트**: Socket.IO 이벤트에 따른 즉각적인 UI 반영
- **애니메이션**: CSS3 애니메이션과 transition 활용
- **반응형 디자인**: 다양한 화면 크기 대응
- **사운드 효과**: Web Audio API 사용

## 7. 게임 플로우 다이어그램

```
[게임 시작]
    ↓
[카드 분배] → 각 플레이어에게 균등 분배
    ↓
[턴 시작] → 현재 플레이어 표시
    ↓
[카드 내기] → 플레이어가 카드 한 장 뒤집기
    ↓
[할리갈리 체크]
    ├─ 조건 만족 → [벨 울리기 가능]
    │                  ├─ 성공 → 카드 획득 → [다음 턴]
    │                  └─ 실패 → 카드 버림 → [다음 턴]
    └─ 조건 불만족 → [다음 턴]
         ↓
    [게임 종료 체크]
         ├─ 계속 → [턴 시작]
         └─ 종료 → [결과 화면]
```

## 8. 주요 함수 및 메서드

### 8.1 게임 관리
- `startGame(roomId)`: 게임 시작 및 카드 분배
- `playCard(roomId, playerId, cardIndex)`: 카드 내기
- `handleHalliGalli(roomId, playerId)`: 할리갈리 처리
- `checkGameEnd(roomId)`: 게임 종료 확인
- `getGameState(roomId)`: 현재 게임 상태 조회

### 8.2 카드 유틸리티
- `createDeck()`: 56장의 카드 덱 생성
- `shuffleCards(cards)`: 카드 섞기
- `dealCards(players, deck)`: 플레이어들에게 카드 분배
- `calculateCardSum(cards)`: 카드 과일별 합계 계산
- `checkHalliGalli(cards)`: 할리갈리 조건 확인

### 8.3 UI 업데이트
- `showGameUI(gameData)`: 게임 UI 표시
- `updatePlayerCardCounts(players)`: 플레이어 카드 개수 업데이트
- `updateTurnIndicator(turn, players)`: 현재 턴 표시
- `addCenterCard(playerId, playerName, card)`: 중앙 카드 추가
- `updateDiscardPile(discardedCards)`: 버림 카드 더미 업데이트
- `clearAllCenterCards()`: 모든 중앙 카드 제거

## 9. 향후 개선 사항

### 9.1 기능 추가
- [ ] 관전자 모드
- [ ] 리플레이 기능
- [ ] 통계 및 순위표
- [ ] 친구 초대 기능
- [ ] 커스텀 게임 룰 설정

### 9.2 UI/UX 개선
- [ ] 더 다양한 애니메이션
- [ ] 테마 선택 기능
- [ ] 접근성 개선 (키보드 단축키 등)
- [ ] 모바일 최적화

### 9.3 기술적 개선
- [ ] 게임 로그 저장
- [ ] 데이터베이스 연동
- [ ] 사용자 인증 시스템
- [ ] 서버 부하 분산

---

**마지막 업데이트**: 2025-10-24
**버전**: 1.0.0
